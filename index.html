<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messenger Firestore</title>

  <link rel="stylesheet" href="./assets/style.css">
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <div class="friends">
  <div class="auth-links">
  <a href="./login.html">ÄÄƒng nháº­p</a>
  <span>Â·</span>
   <a href="./register.html">ÄÄƒng kÃ½</a>
</div>
    <div class="friends-header">Äoáº¡n chat</div>
    <input class="search" placeholder="TÃ¬m kiáº¿m trÃªn Messenger">
    <div class="friend-list" id="friendList"></div>
  </div>

  <!-- CHAT -->
  <div class="chat-app">
    <div class="chat-header" id="chatHeader">
      Chá»n báº¡n Ä‘á»ƒ chat
    </div>

    <div class="chat-body" id="chatBody"></div>

    <div class="chat-input">
      <input id="msgInput" placeholder="Aa">
      <button id="sendBtn">â¤</button>
    </div>
  </div>
</div>

  <!-- ===== FIREBASE + JS ===== -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import{
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      where,
      serverTimestamp
  }from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBRsYiJX-i97pt7gmg0t0fRrJiKPYmtn_s",
    authDomain: "jsi36-a45bc.firebaseapp.com",
    projectId: "jsi36-a45bc",
    storageBucket: "jsi36-a45bc.firebasestorage.app",
    messagingSenderId: "346562660239",
    appId: "1:346562660239:web:18be6a1d29bd8d600dedfa"
  };

  // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const friendList = document.getElementById("friendList");
    const chatBody = document.getElementById("chatBody");
    const chatHeader = document.getElementById("chatHeader");
    const input = document.getElementById("msgInput");

    let currentFriend = null;

    // ğŸ‘¥ LOAD FRIEND LIST
    onSnapshot(collection(db, "friends"), (snap) => {
      friendList.innerHTML = "";
      snap.forEach(doc => {
        const f = doc.data();
        const div = document.createElement("div");

        div.className = "friend";
        div.innerHTML = `
          <div class="avatar"></div>
          <div>${f.name}</div>
        `;

        div.onclick = () => {
          currentFriend = doc.id;
          chatHeader.textContent = f.name;
          loadMessages();
        };

        friendList.appendChild(div);
      });
    });

    // ğŸ’¬ LOAD MESSAGE THEO FRIEND
    function loadMessages() {
      const q = query(
        collection(db, "messages"),
        where("friendId", "==", currentFriend),
        orderBy("createdAt")
      );

      onSnapshot(q, (snap) => {
        chatBody.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const msg = document.createElement("div");

          msg.className = "message " + (d.isMe ? "right" : "left");
          msg.textContent = d.text;

          chatBody.appendChild(msg);
        });

        chatBody.scrollTop = chatBody.scrollHeight;
      });
    }

const sendBtn = document.getElementById("sendBtn");

sendBtn.addEventListener("click", () => {
  if (!currentChatId) return;

  const text = input.value.trim();
  if (!text) return;

  addDoc(collection(db, "messages"), {
    text,
    chatId: currentChatId,
    sender: myId,
    createdAt: Date.now()
  });

  input.value = "";
});
  </script>
</body>
</html>
